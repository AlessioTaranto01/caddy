name: CI/CD Pipeline

on:
  push:
    branches:
      - main
      - development
      - release/*
      - hotfix/*
      - feature/*
  pull_request:
    branches:
      - main
      - development

jobs:
  test:
    name: Run Tests
    runs-on: ubuntu-latest

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Test Docker Build
      run: |
        docker build -t caddy-proxy-test .

    - name: Test Caddy Configuration
      run: |
        docker run --rm caddy-proxy-test caddy validate --config /etc/caddy/Caddyfile

    - name: Run Basic Container Test
      run: |
        # Start container in background
        docker run -d --name caddy-test -p 8080:80 caddy-proxy-test
        
        # Wait for startup
        sleep 10
        
        # Test if Caddy is responding
        curl -f http://localhost:8080 || exit 1
        
        # Cleanup
        docker stop caddy-test
        docker rm caddy-test

  build-and-push:
    name: Build and Push Docker Image
    runs-on: ubuntu-latest
    if: github.ref == 'refs/heads/main' || github.ref == 'refs/heads/development'
    needs: test

    env:
      DOCKER_IMAGE: ${{ secrets.DOCKER_USERNAME }}/caddy-proxy:${{ github.ref_name }}

    steps:
    - name: Checkout Code
      uses: actions/checkout@v3

    - name: Set up Docker
      uses: docker/setup-buildx-action@v2

    - name: Log in to Docker Hub
      uses: docker/login-action@v2
      with:
        username: ${{ secrets.DOCKER_USERNAME }}
        password: ${{ secrets.DOCKER_PASSWORD }}

    - name: Build and Push Docker Image
      run: |
        docker build -t $DOCKER_IMAGE .
        docker push $DOCKER_IMAGE
        echo "âœ… Successfully built and pushed $DOCKER_IMAGE"